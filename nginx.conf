events {
    worker_connections 1024;
}

stream {
    # Logstash upstream definition (load balancing)
    upstream logstash_backend {
        # Load distribution using round-robin method
        server logstash1:5044 max_fails=3 fail_timeout=30s;
        server logstash2:5044 max_fails=3 fail_timeout=30s;
        
        # Examples of other load balancing methods:
        # least_conn;  # Least connections method
        # ip_hash;     # IP hash method (same client to same server)
    }

    # Proxy server configuration
    server {
        listen 5044;
        proxy_pass logstash_backend;
        proxy_timeout 30s;
        proxy_connect_timeout 10s;
        
        # Detailed TCP connection settings
        proxy_next_upstream on;
        proxy_next_upstream_timeout 30s;
        proxy_next_upstream_tries 2;
    }

    # Logging configuration
    log_format basic '$remote_addr - $upstream_addr - [$time_local] '
                     '$protocol $status $bytes_sent $bytes_received '
                     '$session_time';
    
    access_log /var/log/nginx/logstash_access.log basic;
    error_log /var/log/nginx/logstash_error.log;
}